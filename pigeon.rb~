%w(yaml gmail mongo_mapper ./helpers).each { |dependency| require dependency }

def do_gmail(user, credentials)
	gmail = Gmail.new(credentials.username, credentials.password)do |gmail|
	  gmail.inbox.emails(:read).each do |email|
	    extract_links(email).each do |key, val|
       if Link.find_by_remote_url(key).nil?
         begin
           Link.new(:uid=>user.uid, :title=>email.subject, :date=>email.date, :downloaded=>false, :remote_url=>key).save
         rescue
           email.mark(:unread)
         end
        end
      end
	  end
	end

  Link.where(:downloaded=>false).each do |link|
    save_link(link)
  end
end


User.all().each do |user|
  Streams.where(:uid=>user.uid).all().each do |stream|
    if stream.type == 'gmail'
      do_gmail(user, stream.credentials)
    end
  end
end
